
import { supabase } from '@/integrations/supabase/client';
import type { Patient, MedicalHistory } from '@/types/patient';

export const patientService = {
  async getAllPatients(): Promise<Patient[]> {
    const { data, error } = await supabase
      .from('patients')
      .select('*')
      .order('created_at', { ascending: false });
    
    if (error) {
      console.error('Error fetching patients:', error);
      throw new Error(error.message);
    }
    
    return (data || []).map(patient => ({
      id: patient.id,
      mrNumber: patient.mr_number,
      firstName: patient.first_name,
      lastName: patient.last_name,
      dateOfBirth: patient.date_of_birth,
      gender: patient.gender as 'male' | 'female' | 'other',
      contactNumber: patient.contact_number,
      email: patient.email || undefined,
      address: patient.address || undefined,
      registrationDate: patient.registration_date,
      age: patient.age || undefined,
      weight: patient.weight || undefined,
      medicalHistory: [] // Will be loaded separately if needed
    }));
  },
  
  async getPatientById(id: string): Promise<Patient | null> {
    const { data, error } = await supabase
      .from('patients')
      .select('*')
      .eq('id', id)
      .single();
    
    if (error) {
      if (error.code === 'PGRST116') {
        // No rows returned
        return null;
      }
      console.error('Error fetching patient:', error);
      throw new Error(error.message);
    }
    
    if (!data) return null;
    
    // Fetch medical history for this patient
    const { data: medicalHistoryData, error: medicalHistoryError } = await supabase
      .from('medical_histories')
      .select('*')
      .eq('patient_id', id)
      .order('date', { ascending: false });
    
    if (medicalHistoryError) {
      console.error('Error fetching medical history:', medicalHistoryError);
    }
    
    const medicalHistory: MedicalHistory[] = (medicalHistoryData || []).map(history => ({
      id: history.id,
      date: history.date,
      diagnosis: history.diagnosis,
      notes: history.notes || '',
      // The prescriptionId field in our type might not directly match the database
      // If it's null/undefined in the database, we'll return undefined here
      prescriptionId: undefined // We need to modify this if we add this relationship in the future
    }));
    
    return {
      id: data.id,
      mrNumber: data.mr_number,
      firstName: data.first_name,
      lastName: data.last_name,
      dateOfBirth: data.date_of_birth,
      gender: data.gender as 'male' | 'female' | 'other',
      contactNumber: data.contact_number,
      email: data.email || undefined,
      address: data.address || undefined,
      registrationDate: data.registration_date,
      age: data.age || undefined,
      weight: data.weight || undefined,
      medicalHistory
    };
  },
  
  async createPatient(patient: Omit<Patient, 'id' | 'mrNumber' | 'registrationDate' | 'medicalHistory'>): Promise<Patient> {
    const { data: userData } = await supabase.auth.getUser();
    if (!userData.user) throw new Error("User must be logged in to create patients");

    // Convert to snake_case for the database
    // The mr_number field is generated by a database trigger, but Supabase's type
    // system still expects it in the insert. We'll provide an empty string that will be
    // overridden by the trigger.
    const { data, error } = await supabase
      .from('patients')
      .insert({
        first_name: patient.firstName,
        last_name: patient.lastName,
        date_of_birth: patient.dateOfBirth,
        gender: patient.gender,
        contact_number: patient.contactNumber,
        email: patient.email,
        address: patient.address,
        age: patient.age,
        weight: patient.weight,
        created_by: userData.user.id,
        mr_number: '' // Provide an empty string that will be overridden by the database trigger
      })
      .select()
      .single();
    
    if (error) {
      console.error('Error creating patient:', error);
      throw new Error(error.message);
    }
    
    return {
      id: data.id,
      mrNumber: data.mr_number,
      firstName: data.first_name,
      lastName: data.last_name,
      dateOfBirth: data.date_of_birth,
      gender: data.gender as 'male' | 'female' | 'other',
      contactNumber: data.contact_number,
      email: data.email || undefined,
      address: data.address || undefined,
      registrationDate: data.registration_date,
      age: data.age || undefined,
      weight: data.weight || undefined,
      medicalHistory: []
    };
  },
  
  async deletePatients(patientIds: string[]): Promise<void> {
    const { data: userData } = await supabase.auth.getUser();
    if (!userData.user) throw new Error("User must be logged in to delete patients");

    // Start by deleting related records in medical_histories table
    const { error: medicalHistoriesError } = await supabase
      .from('medical_histories')
      .delete()
      .in('patient_id', patientIds);
    
    if (medicalHistoriesError) {
      console.error('Error deleting medical histories:', medicalHistoriesError);
      throw new Error(medicalHistoriesError.message);
    }
    
    // Delete related prescriptions
    const { error: prescriptionsError } = await supabase
      .from('prescriptions')
      .delete()
      .in('patient_id', patientIds);
      
    if (prescriptionsError) {
      console.error('Error deleting prescriptions:', prescriptionsError);
      throw new Error(prescriptionsError.message);
    }
    
    // Delete related payments
    const { error: paymentsError } = await supabase
      .from('payments')
      .delete()
      .in('patient_id', patientIds);
      
    if (paymentsError) {
      console.error('Error deleting payments:', paymentsError);
      throw new Error(paymentsError.message);
    }
    
    // Finally delete the patients
    const { error } = await supabase
      .from('patients')
      .delete()
      .in('id', patientIds);
    
    if (error) {
      console.error('Error deleting patients:', error);
      throw new Error(error.message);
    }
  },
  
  async addMedicalHistory(
    patientId: string,
    history: Omit<MedicalHistory, 'id'>
  ): Promise<MedicalHistory> {
    const { data: userData } = await supabase.auth.getUser();
    if (!userData.user) throw new Error("User must be logged in to add medical history");

    const { data, error } = await supabase
      .from('medical_histories')
      .insert({
        patient_id: patientId,
        date: history.date,
        diagnosis: history.diagnosis,
        notes: history.notes,
        // We don't have prescription_id in the medical_histories table according to the error
        // If we need to establish this relationship, we should modify the database schema
        created_by: userData.user.id
      })
      .select()
      .single();
    
    if (error) {
      console.error('Error adding medical history:', error);
      throw new Error(error.message);
    }
    
    return {
      id: data.id,
      date: data.date,
      diagnosis: data.diagnosis,
      notes: data.notes || '',
      prescriptionId: history.prescriptionId // Keep the original prescriptionId from the parameter
    };
  }
};
